##29.2.2 获得一致的得分

Elasticsearch使用分片和备份进行操作，这一事实为获得好的打分带来了挑战。



###分数不可复制

假设同一个用户连续两次运行同一个请求，而两次返回的文档顺序都不相同，这是一种相当糟糕的体验，不是吗？不幸的是，如果您有备份，这种情况可能会发生(`index.number_of_replicas`大于0）。原因是Elasticsearch以循环方式选择查询应该转到的分片，因此如果您连续运行同一查询两次，它很可能会转到同一分片的不同副本。


为什么这是个问题？索引统计是分数的重要组成部分。由于被删除的文档，这些索引统计数据在同一个分片的副本中可能不同。如您所知，当删除或更新文档时，旧文档不会立即从索引中删除，它只是标记为已删除，并且只有在下次合并此旧文档所属的段时才会从磁盘中删除。然而，出于实际原因，在索引统计中会考虑这些删除的文件。因此，假设主分片刚刚完成了一个删除了大量已删除文档的大型合并，那么它的索引统计信息可能与副本（仍然有大量已删除文档）有大量的不同，因此得分也不同。


解决此问题的建议方法是使用一个字符串，将登录的用户（例如用户id或会话id）标识为[首选项]()。这确保了给定用户的所有查询总是会命中相同的分片，因此查询之间的分数保持更一致。


这种解决方法还有另一个好处：当两个文档具有相同的分数时，默认情况下，它们将按其内部Lucene doc id（与`_id`无关）排序。但是，这些doc id在同一个分片的多个副本中可能是不同的。因此，通过总是命中同一个分片，我们将获得具有相同分数的文档的更一致的排序。


###相关性看起来是错误的

如果您注意到具有相同内容的两个文档得到不同的分数，或者某个完全匹配的文档没有排在第一位，那么这个问题可能与分片有关。默认情况下，Elasticsearch使每个分片负责生成自己的分数。但是，由于索引统计信息对得分有重要影响，因此只有当分片具有类似的索引统计信息时，这种方法才能很好地工作。假设是，由于默认情况下文档均匀地路由到分片，那么索引统计数据应该非常相似，评分也会像预期的那样起作用。但是，如果您：

* 在索引时使用路由
* 查询多个索引
* 或者索引中的数据太少

然后，很有可能搜索请求中涉及的所有分片都没有类似的索引统计信息，相关性可能很差。


如果您有一个小的数据集，解决这个问题的最简单方法就是将所有内容索引到一个只有一个分片的索引中(`index.number_of_shards：1`），这是默认值。然后所有文档的索引统计将是相同的，分数将是一致的。


否则，解决此问题的建议方法是使用[`dfs_query_then_fetch`]()搜索类型。这将使Elasticsearch对所有涉及的分片执行一次初始往返，请求它们提供与查询相关的索引统计信息，然后协调节点将合并这些统计信息，并在请求分片执行[查询]()阶段时将合并的统计信息与请求一起发送，以便分片可以使用这些全局统计信息而不是自己统计来做评分。


在大多数情况下，这种额外的往返旅行应该非常便宜。但是，如果您的查询包含大量字段/术语或模糊查询，请注意单独收集统计信息可能并不便宜，因为必须在术语词典中查找所有术语才能查找统计信息。


