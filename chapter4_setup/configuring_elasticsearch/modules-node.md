#节点 Node

无论何时启动Elasticsearch实例，都是在启动*节点*。连接节点的集合称为[集群]()。如果您运行的是Elasticsearch的单个节点，那么您就拥有一个节点的集群。

默认情况下，集群中的每个节点都可以处理[HTTP]()和[Transport]()流量。Transport层专门用于节点之间的通信；HTTP层由REST客户端使用。

所有节点都知道集群中的所有其他节点，并且可以将客户端请求转发到相应的节点。

默认情况下，节点包括了以下所有类型：主选举、数据、摄取和（如果可用）机器学习。所有数据节点也是变换节点。

> 随着集群的增长，特别是如果您有大型机器学习作业或连续变换，请考虑将节点拆分为专用的主选举节点、专用的数据节点、机器学习节点和变换节点。


##节点角色

可以通过设置`node.roles`来定义节点的角色。如果未配置此设置，则默认情况下节点具有以下角色：

* `master`
* `data`
* `ingest`
* `ml`
* `remote_cluster_client`
* `transform`


> 如果设置了`node.roles`，则只会为节点分配指定的角色。


###[主选举节点]()

具有`master`角色（默认）的节点，使其[有资格被选举为控制集群的*主*节点]()。

###[数据节点]()

具有`data`角色（默认）的节点。数据节点保存数据并执行与数据相关的操作，如CRUD、搜索和聚合。

###[摄取节点]()

具有`ingest`角色（默认）的节点。摄取节点能够对文档使用[摄取管道]()，以便在索引之前转换和丰富文档。对于繁重的摄取负载，使用专用摄取节点并且不包括具有`master`角色或`data`角色的节点的`ingest`角色是有意义的。

###[远程选举节点]()

具有`remote_cluster_client`角色（默认）的节点，使其有资格充当远程客户端。默认情况下，集群中的任何节点都可以充当跨集群客户端并连接到远程集群。

###[机器学习节点]()

已配置了`xpack.ml.enabled`和`ml`角色的节点，这是Elasticsearch默认分发中的默认行为。如果要使用机器学习功能，集群中必须至少有一个机器学习节点。有关机器学习功能的更多信息，请参阅[Elastic Stack中的机器学习]()。

> 如果您只使用OSS发行版的elasticsearch，请不要添加`ml`角色。否则，节点无法启动。

###[转换节点]()

具有`transform`角色的节点。如果要使用转换，则群集中必须至少有一个转换节点。有关详细信息，请参见[转换设置]()和[*转换数据*]()。

> ###协调节点
> 
> 搜索请求或批量索引请求等请求可能涉及不同数据节点上保存的数据。例如，搜索请求分两个阶段执行，这两个阶段由接收客户端请求的节点协调 — *协调节点*。
> 
> 在*分散*阶段，协调节点将请求转发给保存数据的数据节点。每个数据节点在本地执行请求并将其结果返回到协调节点。在*收集*阶段，协调节点将每个数据节点的结果减少为单个全局结果集。
> 
> 每个节点都隐式地是一个协调节点。这意味着，通过将一个节点的`node.roles`显式地设为空列表并不会禁用该节点，而是使该节点仅充当协调节点，无法禁用该节点。因此，这样的节点需要有足够的内存和CPU来处理收集阶段。


##主选举节点

主节点负责整个集群范围的轻量级操作，例如创建或删除索引、跟踪哪些节点是集群的一部分以及决定将哪些分片分配给哪些节点。拥有一个稳定的主节点对于集群健康非常重要。

不是[仅投票节点]()的任何主选举节点可以通过[主节点选举过程]()被推选成为主节点。

> 主节点必须具有对`data/`目录的访问权限（就像`data`节点一样），因为这是在节点重新启动之间保持集群状态的地方。

###专用主节点

被选举的主节点拥有履行其职责所需的资源对于集群的健康非常重要。如果被选举的主节点被其他任务超载，那么集群可能无法正常运行。特别是，索引和搜索数据可能会占用大量资源，因此在大型或高吞吐量集群中，最好避免使用主选举节点来执行索引和搜索等任务。您可以通过将三个节点配置为专用的主节点来实现这一点。专用的主节点仅具有主节点角色，允许它们专注于管理集群。虽然主节点也可以充当[协调节点]()，并将搜索和索引请求从客户端路由到数据节点，但最好不要为此使用专用主节点。

要在默认分发中创建专用的主节点，请设置：


```json
node.master: true ①
node.voting_only: false ② 
node.data: false ③
node.ingest: false ④
node.ml: false ⑤
xpack.ml.enabled: true ⑥ 
node.transform: false ⑦
node.remote_cluster_client: false ⑧ 
```

①默认情况下启用`node.master`角色。

②默认情况下，`node.voting_only`角色处于禁用状态。

③禁用`node.data`角色（默认情况下启用）。

④禁用`node.ingest`角色（默认情况下已启用）。

⑤禁用`node.ml`角色（默认情况下启用）。

⑥`xpack.ml.enabled`设置在默认情况下处于启用状态。

⑦禁用`node.transform`角色。

⑧禁用远程群集连接（默认情况下已启用）。

要在仅OSS发行版中创建专用的主选举节点，请设置：

```json
node.master: true ①
node.data: false ②
node.ingest: false ③
node.remote_cluster_client: false ④
```

①默认情况下启用`node.master`角色。

②禁用`node.data`角色（默认情况下启用）。

③禁用`node.ingest`角色（默认情况下已启用）。

④禁用远程群集连接（默认情况下已启用）。


##数据节点

数据节点保存包含已索引的文档的分片。数据节点处理与数据相关的操作，如CRUD、搜索和聚合。这些操作是I/O、内存和CPU密集型的。监视这些资源并在它们过载时添加更多的数据节点非常重要。

拥有专用数据节点的主要好处是主角色和数据角色的分离。

要在默认分发中创建专用数据节点，请设置：

```json
node.master: true ①
node.voting_only: false ② 
node.data: false ③
node.ingest: false ④
node.ml: false ⑤
xpack.ml.enabled: true ⑥ 
node.transform: false ⑦
node.remote_cluster_client: false ⑧ 
```

##摄取节点

摄取节点可以执行预处理管道，该管道由一个或多个摄取处理器组成。根据摄取处理器执行的操作类型和所需资源，可能有专用的摄取节点是有意义的，这将仅执行此特定任务。

要在默认分发中创建专用摄取节点，请设置：

```json
node.master: false ①
node.voting_only: false ②
node.data: false ③
node.ingest: true ④
node.ml: false ⑤
node.transform: false ⑥ 
node.remote_cluster_client: false 
```


##更改节点的角色

每个数据节点在磁盘上维护以下数据：

* 分配给该节点的每个分片的分片数据，
* 与分配给该节点的每个分片对应的索引元数据
* 集群范围的元数据，如设置和索引模板。

类似地，每个主节点在磁盘上维护以下数据：

* 群集中每个索引的索引元数据
* 集群范围的元数据，如设置和索引模板。

每个节点在启动时检查其数据路径的内容。如果它发现意外数据，那么它将拒绝启动。这是为了避免导入不需要的[悬空索引]()，这会导致红色的集群运行状况。更准确地说，设置为`node.data:false`的节点如果在启动时在磁盘上发现任何分片数据，则会拒绝启动；设置了`node.master:false`和`node.data:false`的节点如果在启动时在磁盘上发现任何索引元数据，则会拒绝启动。

可以通过调整其`elasticsearch.yml`文件并重新启动来更改节点的角色。这称为*重新调整*节点。为了满足上述对意外数据的检查，在将节点的`node.data`或`node.master`角色设置为`false`时，必须执行一些额外的步骤来准备节点重新调整用途：

* 如果要通过将`node.data`更改为`false`来重新调整数据节点，则应首先使用[分配筛选器]()将所有分片数据安全地迁移到集群中的其他节点上。

* 如果要重新调整节点的用途，使其同时具有`node.master:false`和`node.data:false`，则最简单的方法是使用空数据路径和所需角色启动一个全新的节点。您可能会发现，首先使用[分配筛选器]()将分片数据迁移到集群中的其他位置是最安全的。

如果无法执行这些额外步骤，则可以使用[elasticsearch节点调整工具]()删除阻止节点启动的任何多余数据。


##节点数据路径设置

###`path.data`

```json
path.data:  /var/elasticsearch/data
```

```json
./bin/elasticsearch -Epath.data=/var/elasticsearch/data
```

使用`.zip`或`.tar.gz`发行版时，应将`path.data`设置配置为将数据目录定位到Elasticsearch主目录之外，以便在不删除数据的情况下删除主目录！RPM和Debian发行版已经为您完成了这项工作。


###`node.max_local_storage_nodes`

[数据路径]()可以由多个节点共享，甚至可以由来自不同集群的节点共享。但是，建议仅使用相同的数据路径运行Elasticsearch的一个节点。此设置在7.x中已弃用，将在8.0版中删除。

默认情况下，Elasticsearch配置为防止多个节点共享同一数据路径。要允许多个节点（例如，在开发机器上），请使用设置`node.max_local_storage_nodes`并将其设置为大于1的正整数。

> 切勿从同一数据目录运行不同的节点类型（即主节点、数据节点）。这可能导致意外的数据丢失。


##其他节点设置

更多的节点设置可以参见 [配置Elasticsearch]() 和 [重要Elasticsearch配置]()，包括：

* [`cluster.name`]()
* [`node.name`]()
* [网络设置]()

