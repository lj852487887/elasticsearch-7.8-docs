#Reading and Writing documents 阅读和写作文档

##简介

Elasticsearch中的每个索引都[分为多个分片]()，每个分片可以有多个副本。这些副本称为*复制组*，在添加或删除文档时必须保持同步。如果我们不能做到这一点，那么从一个拷贝上读会得到与从另一个拷贝上读截然不同的结果。保持分片拷贝同步并从中读取数据的过程被称为*数据复制模型*。



Elasticsearch的数据复制模型基于*主备份模型*，在Microsoft Research的[PacificA论文]()中有很好的描述。该模型基于复制组中作为主分片的单个副本。其他副本称为副本分片。主索引作为所有索引操作的主入口点。它负责验证它们并确保它们是正确的。一旦索引操作被主副本接受，主副本还负责将该操作复制到其他副本。



本节的目的是从高层次概述Elasticsearch复制模型，并讨论它对写操作和读操作之间的各种交互的影响。



基本写入模型编辑

Elasticsearch中的每个索引操作首先使用路由解析到一个复制组，通常基于文档ID。一旦确定了复制组，该操作将在内部转发到该组的当前主分片。索引的这个阶段称为协调阶段。



索引的下一个阶段是主阶段，在主分片上执行。主分片负责验证操作并将其转发给其他副本。由于副本可以脱机，因此不需要主副本复制到所有副本。相反，Elasticsearch维护一个应该接收操作的分片副本列表。此列表称为同步副本，由主节点维护。顾名思义，这是一组“良好的”分片副本，保证已处理所有已向用户确认的索引和删除操作。主服务器负责维护这个不变量，因此必须将所有操作复制到此集中的每个副本。



主分片遵循以下基本流程：



验证传入操作并在结构无效时拒绝它（例如：在需要数字的对象字段中）

在本地执行操作，即索引或删除相关文档。这还将验证字段的内容，并在需要时拒绝（例如：关键字值太长，无法在Lucene中进行索引）。

将操作转发到当前同步副本集中的每个副本。如果有多个副本，则并行执行。

一旦所有副本成功地执行了操作并响应了主副本，主副本就会向客户端确认请求的成功完成。

每个同步副本副本都在本地执行索引操作，以便它有一个副本。索引的这个阶段就是复制阶段。



这些索引阶段（协调、主索引和副本索引）是连续的。要启用内部重试，每个阶段的生存期包含每个后续阶段的生存期。例如，协调阶段直到每个主要阶段（可能分布在不同的主要分片上）完成才完成。在同步副本完成本地文档索引并响应副本请求之前，每个主阶段都不会完成。